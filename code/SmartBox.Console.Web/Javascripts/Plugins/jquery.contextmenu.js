(function(a){function b(){return false}a.fn.contextmenu=function(c){c=a.extend({alias:"cmroot",width:150},c);var m=null,w=null,d={},f={},n={},g=[],u="<div class='b-m-$[type]' unselectable=on><nobr unselectable=on><img src='$[icon]' align='absmiddle'/><span unselectable=on>$[text]</span></nobr></div>",k=a("<div/>").addClass("b-m-mpanel").attr("unselectable","on").css("display","none"),l=a("<div/>").addClass("b-m-item").attr("unselectable","on"),s=a("<div/>").addClass("b-m-split"),i=function(c){d[c.alias]=this;this.gidx=c.alias;this.id=c.alias;if(c.disable){this.disable=c.disable;this.className="b-m-idisable"}a(this).width(c.width).click(b).mousedown(b).appendTo(a("body"));c=null;return this},j=function(a){var b=this;b.title=a.text;b.idx=a.alias;b.gidx=a.gidx;b.data=a;b.innerHTML=u.replace(/\$\[([^\]]+)\]/g,function(){return a[arguments[1]]});if(a.disable){b.disable=a.disable;b.className="b-m-idisable"}a.items&&(b.group=true);a.action&&(n[a.alias]=a.action);f[a.alias]=b;b=a=null;return this},q=function(g,c){for(var f=null,e=0;e<c.length;e++){if(c[e].type=="splitLine")f=s.clone()[0];else{c[e].gidx=g;if(c[e].type=="group"){i.apply(k.clone()[0],[c[e]]);arguments.callee(c[e].alias,c[e].items);c[e].type="arrow";f=j.apply(l.clone()[0],[c[e]])}else{c[e].type="ibody";f=j.apply(l.clone()[0],[c[e]]);a(f).click(function(){if(!this.disable){a.isFunction(n[this.idx])&&n[this.idx].call(this,w);h()}return false})}a(f).bind("contextmenu",b).hover(r,v)}d[g].appendChild(f);f=c[e]=c[e].items=null}g=c=null},r=function(){if(this.disable)return false;h.call(d[this.gidx]);if(this.group){var c=a(this).offset(),b=a(this).outerWidth();o.apply(d[this.idx],[c,b])}this.className="b-m-ifocus";return false},v=function(){if(this.disable)return false;if(!this.group)this.className="b-m-item";return false},o=function(b,c){var h=a("body").width(),f=document.documentElement.clientHeight,e=a(this).outerWidth(),d=a(this).outerHeight();b.left=b.left+c+e>h?b.left-e<0?0:b.left-e:b.left+c;b.top=b.top+d>f?b.top-d+(c>0?25:0)<0?0:b.top-d+(c>0?25:0):b.top;a(this).css(b).show();g.push(this.gidx)},h=function(){for(var a=null,b=g.length-1;b>=0;b--){if(g[b]==this.gidx)break;a=g.pop();d[a].style.display="none";f[a]&&(f[a].className="b-m-item")}};function p(a){if(m&&m==a.name)return false;for(var b in f)t(b,!a.disable);for(var b=0;b<a.items.length;b++)t(a.items[b],a.disable);m=a.name}function t(c,b){var a=f[c];a.className=(a.disable=a.lastChild.disabled=b)?"b-m-idisable":"b-m-item"}function y(b,c){w=c;o.call(d.cmroot,{left:b.pageX,top:b.pageY},0);a(document).one("mousedown",h)}var x=a("#"+c.alias),e=null;if(x.length==0){e=i.apply(k.clone()[0],[c]);e.applyrule=p;e.showMenu=y;q(c.alias,c.items)}else e=x[0];var z=a(this).each(function(){return a(this).bind("contextmenu",function(b){var d=c.onContextMenu&&a.isFunction(c.onContextMenu)?c.onContextMenu.call(this,b):true;if(d){c.onShow&&a.isFunction(c.onShow)&&c.onShow.call(this,e);e.showMenu(b,this)}return false})});c.rule&&p(c.rule);k=l=s=u=i=j=null;q=r=v=null;return z}})(jQuery);